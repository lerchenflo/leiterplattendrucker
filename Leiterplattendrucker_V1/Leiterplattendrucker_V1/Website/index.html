<!DOCTYPE html>
<html>
<head>
  <title>PCB Printer Website</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>PCB Printer Website</h1>
  
  <p>Wilkommen auf der PCB Printer Seite. Auf dieser Seite können Gerber-Dateine hochgeladen werden um diese vom Drucker drucken zu lassen.<br>
    Zum Start laden sie Bitte ihre Gerber-Datei hoch.
  </p>    

  <!--Upload-field for Gerberfiles-->
  <div id="uploaddiv">
    <form class="upload-form">
      <label for="file-selector" class="file-label">Select a Gerber File:</label>
      <input
        id="file-selector"
        type="file"
        name="file1"
        accept=".gbr, .gerber, .gtl"
        class="file-input"
      />
    </form>
  </div>
  
  <!--open settings popup-->
  <div id="settingsdiv" class="center" title="Open the settings-popup">
    <div onclick="openPopup()" class="settings-button">
      <img src="./images/settings.png" alt="Settings icon" class="icon">
      <span>Einstellungen</span>
    </div> 
  </div>

  <!--Button to start the printing process-->
  <div class="center">
    <button id="startprinting" disabled title="upload a gerberfile first">Start Print</button>
  </div>

  <!--Settings popup-->
  <div id="settings-popup" class="popup">
    <div class="popup-content">
      <fieldset>
        <legend>Einstellungen</legend>
        <label for="filling-level">Polygon füllgrad</label>
        <input id="filling-level" type="number" value="0.5" min="0.3" max="2" step="0.1" />
        <br>
        <label for="pad-size">Pad größe</label>
        <input id="pad-size" type="number" value="0.5" min="0.1" max="1" step="0.1" />
      </fieldset>
    
      <div class="spacer"></div>
    
      <button id="resetbutton">
          Reset to default
      </button>
      <button class="close-btn" onclick="closePopup()">Close</button>
    </div>
  </div>

  
<!--Preview of the driven path-->
  <div id="previewdiv">
    <canvas id="pcbPreview" width="500" height="300" style="border:1px solid #000000;"></canvas>
  </div>

  <div class="legend">
    <div class="legend-item">
        <div class="color-box gold"></div>
        <span>Drawing</span>
    </div>
    <div class="legend-item">
        <div class="color-box red"></div>
        <span>Not Drawing</span>
    </div>
  </div>

  <!-- JS code-->
  <script src="./js/ui.js" type="module"></script>

  <script>
    // Open popup
    function openPopup() {
      document.getElementById("settings-popup").style.display = "flex";
    }

    // Close popup
    function closePopup() {
      document.getElementById("settings-popup").style.display = "none";
    }
  </script>

<script type="module">
  import {set_settings} from './js/network_task.js';

  // input fields for filling-level and pad-size
  const fillLvlInp = document.getElementById("filling-level");
  const padfillLvlInp = document.getElementById("pad-size");

  fillLvlInp.onchange = function(){
      set_settings(padfillLvlInp.value, fillLvlInp.value);
  }
  padfillLvlInp.onchange = function(){
    set_settings(padfillLvlInp.value, fillLvlInp.value);
  }

  const resetButton = document.getElementById("resetbutton");
  resetButton.onclick = function(){
      // todo send command(s) to server
      
      //todo update ui elemets
      console.log("Resetting to default values");
  }

</script>

  <script type="module">
    import {send_gerber, isPrinting, start} from './js/network_task.js';
    import {drawPreviewFromServer, redirectIfPrinting} from './js/ui.js';
    
    redirectIfPrinting();

    // Load Gerber file using js, sending it to the server in Textformat
    const fileSelector = document.getElementById('file-selector');
      fileSelector.addEventListener('change', (event) => {
        const fileList = event.target.files;
        const file = fileList[0];
        if (file) {
            var reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload = function (evt) {
                var content = evt.target.result;
                console.log("Sending Gerber File");
                send_gerber(content); // Sending the geberfile as text
            }
            reader.onerror = function (evt) {
                console.log("error reading file");
            }
        }

        setInterval(drawPreviewFromServer, 500); // get and draw the preview after 500ms
        setTimeout(drawPreviewFromServer, 3000, true, true)

    });

    // Start print -> button onlcick
    const startprintingbtn = document.getElementById('startprinting');
    startprintingbtn.onclick = function(){
        console.log("startprinting");
        start();

        setTimeout(redirectIfPrinting, 500);
    };

    /*
    const homebtn = document.getElementById('home');
    homebtn.onclick = function(){
      console.log("drive to 0 position");

    }
      */

  </script>

</body>
</html>